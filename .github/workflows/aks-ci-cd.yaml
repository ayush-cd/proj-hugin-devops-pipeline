name: Proj Hugin AKS CI/CD

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    environment:
      name: dev  # ðŸ”¥ approval required here

    env:
      ACR_LOGIN_SERVER: hugintestacr.azurecr.io
      ACR_NAME: hugintestacr
      ACR_REPOSITORY: proj-hugin-backend
      AKS_RG: hugin-test-rg
      AKS_CLUSTER_NAME: hugin-test-aks
      KEY_VAULT_NAME: hugin-test-key-vault
      HELM_RELEASE_NAME: proj-hugin-api
      HELM_NAMESPACE: dev
      HELM_CHART_PATH: ./helmchart
      HELM_VALUES_FILE: ./helmchart/config/override-values.yaml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Azure (OIDC)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          az acr login --name $ACR_NAME

      # ðŸ”¥ Auto Increment Build Version
      - name: Increment Version
        id: version
        run: |
          VERSION=${{ vars.BUILD_VERSION }}
          NEW_VERSION=$((VERSION + 1))
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      # ðŸ”¥ Build image with 2 tags: <number>, latest
      - name: Build Docker Image
        run: |
          docker build -t $ACR_LOGIN_SERVER/$ACR_REPOSITORY:$VERSION \
                       -t $ACR_LOGIN_SERVER/$ACR_REPOSITORY:latest .

      # ðŸ”¥ Optional security scan (keep)
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      - name: Scan Image with Trivy
        run: |
          trivy image --exit-code 0 --severity HIGH,CRITICAL $ACR_LOGIN_SERVER/$ACR_REPOSITORY:$VERSION

      # ðŸ”¥ Push only required tags
      - name: Push Docker Images
        run: |
          docker push $ACR_LOGIN_SERVER/$ACR_REPOSITORY:$VERSION
          docker push $ACR_LOGIN_SERVER/$ACR_REPOSITORY:latest

      # ðŸ”¥ Load Key Vault secrets as env variables
      - name: Load Secrets from Azure Key Vault
        uses: azure/cli@v2
        with:
          inlineScript: |
            for secret in DB-URL ACCESS-TOKEN-SECRET REFRESH-TOKEN-SECRET; do
              VALUE=$(az keyvault secret show --vault-name ${{ env.KEY_VAULT_NAME }} --name $secret --query value -o tsv)
              echo "${secret//-/_}=$VALUE" >> $GITHUB_ENV
            done

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Set AKS Context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      # ðŸ”¥ Deploy with version tag
      - name: Deploy Helm Chart to AKS
        run: |
          helm upgrade --install $HELM_RELEASE_NAME $HELM_CHART_PATH \
            -n $HELM_NAMESPACE \
            -f $HELM_VALUES_FILE \
            --atomic \
            --wait --timeout 5m \
            --set image.repository=$ACR_LOGIN_SERVER/$ACR_REPOSITORY \
            --set image.tag=$VERSION \
            --set secret.secrets.DB_URL="$DB_URL" \
            --set secret.secrets.ACCESS_TOKEN_SECRET="$ACCESS_TOKEN_SECRET" \
            --set secret.secrets.REFRESH_TOKEN_SECRET="$REFRESH_TOKEN_SECRET"

      
      
      - name: Install GitHub CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh

      # ðŸ”¥ Save updated version number for next run
      - name: Update Build Version
        if: success()
        run: |
          gh variable set BUILD_VERSION --body "$NEW_VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}