name: Proj Hugin AKS CI/CD

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      # ðŸ”§ CHANGE THESE TO YOUR REAL VALUES
      ACR_LOGIN_SERVER: projhugin.azurecr.io        # e.g. myregistry.azurecr.io
      ACR_REPOSITORY: proj-hugin-backend            # repo inside ACR
      AKS_RG: ayush-rg                               # your resource group
      AKS_CLUSTER_NAME: proj-hugin-dev-aks          # your AKS cluster name
      KEY_VAULT_NAME: projhugin-kv                  # your Key Vault
      HELM_RELEASE_NAME: proj-hugin-api
      HELM_NAMESPACE: dev
      HELM_CHART_PATH: ./helmchart
      HELM_VALUES_FILE: ./helmchart/config/dev-override-values.yaml

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Login to Azure (using AZURE_CREDENTIALS secret)
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. Login to ACR
      - name: Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}

      # 4. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. Build image
      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          docker build -t $ACR_LOGIN_SERVER/$ACR_REPOSITORY:$IMAGE_TAG .

      # 6. Install Trivy & scan
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Trivy scan
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          trivy image --exit-code 0 --severity HIGH,CRITICAL $ACR_LOGIN_SERVER/$ACR_REPOSITORY:$IMAGE_TAG

      # 7. Push image to ACR
      - name: Push Docker image
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          docker push $ACR_LOGIN_SERVER/$ACR_REPOSITORY:$IMAGE_TAG

      # 8. Load secrets from Key Vault into env
      - name: Load Key Vault secrets
        uses: azure/cli@v2
        with:
          inlineScript: |
            KV=${{ env.KEY_VAULT_NAME }}

            get_secret () {
              local NAME=$1
              local VAR=$2
              local VAL
              VAL=$(az keyvault secret show --vault-name "$KV" --name "$NAME" --query value -o tsv)
              echo "$VAR=$VAL" >> $GITHUB_ENV
            }

            # ðŸ”§ secret names in Key Vault
            get_secret "DB-URL"               "DB_URL"
            get_secret "ACCESS-TOKEN-SECRET"  "ACCESS_TOKEN_SECRET"
            get_secret "REFRESH-TOKEN-SECRET" "REFRESH_TOKEN_SECRET"

      # 9. Install kubectl & Helm
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "latest"

      # 10. Get AKS context
      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      # 11. Deploy to AKS with Helm
      - name: Deploy Helm chart
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          helm upgrade --install $HELM_RELEASE_NAME $HELM_CHART_PATH \
            -n $HELM_NAMESPACE \
            -f $HELM_VALUES_FILE \
            --create-namespace \
            --atomic --wait --timeout 5m0s \
            --set image.repository=$ACR_LOGIN_SERVER/$ACR_REPOSITORY \
            --set image.tag=$IMAGE_TAG \
            --set secret.secrets.DB_URL=$DB_URL \
            --set secret.secrets.ACCESS_TOKEN_SECRET=$ACCESS_TOKEN_SECRET \
            --set secret.secrets.REFRESH_TOKEN_SECRET=$REFRESH_TOKEN_SECRET
