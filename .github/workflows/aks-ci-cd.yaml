name: Proj Hugin AKS CI/CD

permissions:
  id-token: write
  contents: read
  actions: read

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      ACR_LOGIN_SERVER: hugintestacr.azurecr.io
      ACR_NAME: hugintestacr
      ACR_REPOSITORY: proj-hugin-backend
      AKS_RG: hugin-test-rg
      AKS_CLUSTER_NAME: hugin-test-aks
      KEY_VAULT_NAME: hugin-test-key-vault
      HELM_RELEASE_NAME: proj-hugin-api
      HELM_NAMESPACE: dev
      HELM_CHART_PATH: ./helmchart
      HELM_VALUES_FILE: ./helmchart/config/dev-override-values.yaml

    steps:
      # ------------------------------------
      # 1. Checkout Code
      # ------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------
      # 2. Login to Azure using OIDC
      # ------------------------------------
      - name: Authenticate to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ------------------------------------
      # 3. ACR Login using Azure identity
      # ------------------------------------
      - name: Login to Azure Container Registry (OIDC)
        run: |
          az acr login --name $ACR_NAME

      # ------------------------------------
      # 4. Buildx Setup
      # ------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ------------------------------------
      # 5. Build Image
      # ------------------------------------
      - name: Build Docker Image
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          docker build -t $ACR_LOGIN_SERVER/$ACR_REPOSITORY:${IMAGE_TAG} .

      # ------------------------------------
      # 6. Trivy Security Scan
      # ------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      - name: Trivy Scan Image
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          trivy image --exit-code 0 --severity HIGH,CRITICAL $ACR_LOGIN_SERVER/$ACR_REPOSITORY:$IMAGE_TAG

      # ------------------------------------
      # 7. Push Image to ACR
      # ------------------------------------
      - name: Push Image to ACR
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          docker push $ACR_LOGIN_SERVER/$ACR_REPOSITORY:${IMAGE_TAG}

      # ------------------------------------
      # 8. Pull secrets from Azure Key Vault
      # ------------------------------------
      - name: Load Secrets from Azure Key Vault
        uses: azure/cli@v2
        with:
          inlineScript: |
            for secret in DB-URL ACCESS-TOKEN-SECRET REFRESH-TOKEN-SECRET; do
              VALUE=$(az keyvault secret show --vault-name ${{ env.KEY_VAULT_NAME }} --name $secret --query value -o tsv)
              echo "${secret//-/_}=$VALUE" >> $GITHUB_ENV
            done

      # ------------------------------------
      # 9. Install kubectl & Helm
      # ------------------------------------
      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      # ------------------------------------
      # ðŸ”¥ 10. Connect to AKS
      # ------------------------------------
      - name: Set AKS Context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      # ------------------------------------
      # 11. Deploy to AKS using Helm
      # ------------------------------------
      - name: Deploy Helm Chart
        env:
          IMAGE_TAG: ${{ github.run_id }}
        run: |
          helm upgrade --install $HELM_RELEASE_NAME $HELM_CHART_PATH \
            -n $HELM_NAMESPACE \
            -f $HELM_VALUES_FILE \
            --create-namespace \
            --atomic --wait --timeout 5m \
            --set image.repository=$ACR_LOGIN_SERVER/$ACR_REPOSITORY \
            --set image.tag=$IMAGE_TAG \
            --set secret.secrets.DB_URL=$DB_URL \
            --set secret.secrets.ACCESS_TOKEN_SECRET=$ACCESS_TOKEN_SECRET \
            --set secret.secrets.REFRESH_TOKEN_SECRET=$REFRESH_TOKEN_SECRET
